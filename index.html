<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å“ˆçˆ¾æ¿±æ¥µå…‰ä¹‹æ—… (å®¶åº­ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #F7F9FB;
            --card-bg: #FFFFFF;
            --text-main: #2C3E50;
            --text-sub: #7F8C8D;
            --accent-blue: #5D8AA8;
            --tag-food: #E67E22;
            --tag-view: #27AE60;
            --tag-transport: #2980B9;
            --tag-stay: #8E44AD;
            --nav-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0 0 calc(var(--nav-height) + 20px) 0;
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 1px; }
        .subtitle { font-size: 11px; color: var(--text-sub); margin-top: 5px; }
        .live-indicator { font-size: 10px; color: #27AE60; background: #e8f8f5; padding: 2px 6px; border-radius: 10px; border: 1px solid #27AE60;}

        /* Container */
        .container { padding: 15px; display: none; animation: fadeIn 0.3s ease; }
        .container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Weather */
        .weather-banner {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #444;
        }
        
        /* Itinerary Cards */
        .day-header { margin: 25px 0 10px 0; font-size: 18px; font-weight: 700; color: var(--accent-blue); }
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            position: relative;
            overflow: hidden;
        }
        .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .card.type-view::before { background-color: var(--tag-view); }
        .card.type-food::before { background-color: var(--tag-food); }
        .card.type-transport::before { background-color: var(--tag-transport); }
        .card.type-stay::before { background-color: var(--tag-stay); }
        .card-title { font-size: 16px; font-weight: 600; margin: 0 0 5px 0; }
        .card-time { font-size: 12px; color: var(--text-sub); background: #f0f2f5; padding: 2px 6px; border-radius: 4px; }
        .card-desc { font-size: 14px; color: #555; line-height: 1.5; margin-bottom: 10px; margin-top: 8px;}
        .guide-tip { background-color: #FEF9E7; border-radius: 8px; padding: 10px; font-size: 13px; color: #7D6608; margin-top: 10px; border-left: 3px solid #F1C40F; }
        .btn-nav { display: inline-flex; align-items: center; justify-content: center; width: 100%; padding: 10px; background: #f8f9fa; color: var(--accent-blue); text-decoration: none; border-radius: 8px; font-size: 13px; font-weight: 600; margin-top: 10px; }

        /* Info Section */
        .info-block { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #eee; }
        .info-label { font-size: 12px; color: var(--text-sub); display: block; }
        .info-value { font-size: 16px; font-weight: 500; }

        /* Budget & Chat Styles */
        .input-group { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .form-input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }
        .btn-action { width: 100%; padding: 12px; background: var(--accent-blue); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        
        /* Chat Specific */
        .chat-list { list-style: none; padding: 0; margin-top: 20px; }
        .chat-bubble { background: white; padding: 12px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; }
        .chat-user { font-size: 11px; color: var(--accent-blue); font-weight: bold; margin-bottom: 2px; display: block; }
        .chat-text { font-size: 14px; color: #333; word-break: break-all; }
        .chat-time { font-size: 10px; color: #ccc; float: right; }
        .chat-bubble.mine { background: #EBF5FB; margin-left: 40px; }

        /* Budget Specific */
        .budget-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; align-items: center; }
        .budget-meta { font-size: 12px; color: #999; margin-left: 5px; }
        .total-display { font-size: 24px; font-weight: bold; text-align: center; color: var(--tag-view); margin: 20px 0; background: white; padding: 15px; border-radius: 12px; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: rgba(255,255,255,0.98); border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 200; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { text-align: center; font-size: 10px; color: var(--text-sub); flex: 1; padding: 10px 0; cursor: pointer; }
        .nav-item.active { color: var(--accent-blue); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 4px; }
        
        .delete-btn { color: #ff6b6b; margin-left: 10px; cursor: pointer; padding: 5px; }
    </style>
</head>
<body>

<header>
    <div>
        <h1>China Trip 2025 â„ï¸</h1>
        <div class="subtitle">ä¸Šæµ· â€¢ å“ˆçˆ¾æ¿± â€¢ å…§è’™å¤</div>
    </div>
    <span class="live-indicator">â— ç·šä¸ŠåŒæ­¥ä¸­</span>
</header>

<div id="tab-itinerary" class="container active">
    <div id="itinerary-content"></div>
</div>

<div id="tab-info" class="container">
    <h2>âœˆï¸ èˆªç­è³‡è¨Š</h2>
    <div class="info-block"><span class="info-label">12/24 å»ç¨‹</span><div class="info-value">TPE - SHA (15:05-17:10)</div></div>
    <div class="info-block"><span class="info-label">12/25 è½‰æ©Ÿ</span><div class="info-value">SHA - HRB (07:00-10:00)</div></div>
    <div class="info-block"><span class="info-label">12/29 è¿”ç¨‹æ®µ1</span><div class="info-value">HRB - HGH (19:20-22:40)</div></div>
    <div class="info-block"><span class="info-label">12/30 è¿”ç¨‹æ®µ2</span><div class="info-value">HGH - TPE (09:30-11:25)</div></div>
    <h2>ğŸ¨ ä½å®¿ & ç«è»Š</h2>
    <div class="info-block"><span class="info-label">12/25 ç«è»Š</span><div class="info-value">G1238 (ç€‹é™½) + K7565 (é˜¿çˆ¾å±±)</div></div>
    <div class="info-block"><span class="info-label">12/27 ç«è»Š</span><div class="info-value">K7090 (æ»¿æ´²é‡Œ-å“ˆçˆ¾æ¿±)</div></div>
</div>

<div id="tab-budget" class="container">
    <div class="total-display">ç¸½æ”¯å‡º: Â¥<span id="total-amount">0</span></div>
    
    <div class="input-group">
        <h3>â• æ–°å¢æ”¯å‡º</h3>
        <input type="text" id="expense-who" class="form-input" placeholder="èª°ä»˜çš„? (ä¾‹å¦‚: çˆ¸çˆ¸)">
        <input type="text" id="expense-name" class="form-input" placeholder="é …ç›® (ä¾‹å¦‚: æ™šé¤)">
        <input type="number" id="expense-amount" class="form-input" placeholder="é‡‘é¡ (RMB)">
        <button id="btn-add-expense" class="btn-action">è¨˜ä¸€ç­†</button>
    </div>

    <h3>ğŸ“ æ”¯å‡ºæ˜ç´° (åŒæ­¥ä¸­)</h3>
    <div id="expense-list"></div>
</div>

<div id="tab-chat" class="container">
    <div class="input-group" style="position:sticky; top:80px; z-index:90;">
        <input type="text" id="chat-user" class="form-input" placeholder="ä½ çš„æš±ç¨±" value="æ—…äºº">
        <textarea id="chat-msg" class="form-input" placeholder="ç•™è¨€çµ¦å®¶äºº... (ä¾‹å¦‚: è¨˜å¾—å¸¶æš–æš–åŒ…)" rows="2"></textarea>
        <button id="btn-send-msg" class="btn-action" style="background:var(--tag-transport)">ç™¼é€ç•™è¨€</button>
    </div>
    <div id="chat-list" class="chat-list"></div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('itinerary', this)"><span class="nav-icon">ğŸ—ºï¸</span>è¡Œç¨‹</div>
    <div class="nav-item" onclick="switchTab('info', this)"><span class="nav-icon">ğŸ«</span>è³‡è¨Š</div>
    <div class="nav-item" onclick="switchTab('budget', this)"><span class="nav-icon">ğŸ’°</span>è¨˜å¸³</div>
    <div class="nav-item" onclick="switchTab('chat', this)"><span class="nav-icon">ğŸ’¬</span>ç•™è¨€</div>
</nav>

<script type="module">
    // -----------------------------------------------------------
    // âœ… ä½ çš„ Firebase è¨­å®šæª”å·²ç¶“æˆåŠŸå¡«å…¥ï¼
    // -----------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCTN4SxbLj5j_pVL9AlL899Ockn_cUryq4",
      authDomain: "harbin-trip-2025.firebaseapp.com",
      projectId: "harbin-trip-2025",
      storageBucket: "harbin-trip-2025.firebasestorage.app",
      messagingSenderId: "23165691648",
      appId: "1:23165691648:web:06ba8482fabf449b7735e5",
      measurementId: "G-SJWGZFTV0F"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- 1. è¨˜å¸³åŠŸèƒ½ (Budget) ---
    const expenseListEl = document.getElementById('expense-list');
    const totalAmountEl = document.getElementById('total-amount');

    // ç›£è½è³‡æ–™åº«è®ŠåŒ– (Realtime)
    const qExpenses = query(collection(db, "expenses"), orderBy("timestamp", "desc"));
    
    onSnapshot(qExpenses, (snapshot) => {
        let html = '';
        let total = 0;
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;
            total += Number(data.amount);
            html += `
                <div class="budget-item">
                    <div>
                        <span style="font-weight:bold">${data.name}</span>
                        <span class="budget-meta">${data.who} â€¢ Â¥${data.amount}</span>
                    </div>
                    <span class="delete-btn" data-id="${id}">âœ•</span>
                </div>
            `;
        });
        expenseListEl.innerHTML = html;
        totalAmountEl.innerText = total;

        // ç¶å®šåˆªé™¤æŒ‰éˆ•
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) {
                    await deleteDoc(doc(db, "expenses", e.target.dataset.id));
                }
            });
        });
    });

    // æ–°å¢æ”¯å‡º
    document.getElementById('btn-add-expense').addEventListener('click', async () => {
        const who = document.getElementById('expense-who').value;
        const name = document.getElementById('expense-name').value;
        const amount = document.getElementById('expense-amount').value;

        if(who && name && amount) {
            try {
                await addDoc(collection(db, "expenses"), {
                    who: who,
                    name: name,
                    amount: Number(amount),
                    timestamp: Timestamp.now()
                });
                // æ¸…ç©ºè¼¸å…¥æ¡†
                document.getElementById('expense-name').value = '';
                document.getElementById('expense-amount').value = '';
                alert("è¨˜å¸³æˆåŠŸï¼å®¶äººéƒ½çœ‹å¾—åˆ°å›‰");
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ˜¯ Firebase æ¬Šé™");
            }
        } else {
            alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Šå–”");
        }
    });

    // --- 2. ç•™è¨€æ¿åŠŸèƒ½ (Chat) ---
    const chatListEl = document.getElementById('chat-list');
    const qChat = query(collection(db, "messages"), orderBy("timestamp", "asc"));

    onSnapshot(qChat, (snapshot) => {
        let html = '';
        const currentUser = document.getElementById('chat-user').value || 'æ—…äºº';
        
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            // ç°¡å–®åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªå·±ç™¼çš„
            const isMine = data.user === currentUser ? 'mine' : '';
            const date = data.timestamp ? new Date(data.timestamp.toDate()) : new Date();
            const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

            html += `
                <div class="chat-bubble ${isMine}">
                    <span class="chat-user">${data.user}</span>
                    <div class="chat-text">${data.msg}</div>
                    <div class="chat-time">${timeStr}</div>
                </div>
            `;
        });
        chatListEl.innerHTML = html;
        window.scrollTo(0, document.body.scrollHeight);
    });

    document.getElementById('btn-send-msg').addEventListener('click', async () => {
        const user = document.getElementById('chat-user').value;
        const msg = document.getElementById('chat-msg').value;

        if(user && msg) {
            await addDoc(collection(db, "messages"), {
                user: user,
                msg: msg,
                timestamp: Timestamp.now()
            });
            document.getElementById('chat-msg').value = '';
        }
    });

</script>

<script>
    // --- éœæ…‹è¡Œç¨‹è³‡æ–™ (ç„¡é ˆè³‡æ–™åº«) ---
    const itineraryData = [
        {
            date: "12/24 (ä¸‰)", location: "ä¸Šæµ·", weather: "â˜ï¸ 5~10Â°C",
            events: [
                { type: "transport", title: "âœˆï¸ å°åŒ— - ä¸Šæµ·", time: "15:05", desc: "æŠµé”ä¸Šæµ·", nav: "æµ¦æ±åœ‹éš›æ©Ÿå ´" },
                { type: "view", title: "å¤–ç˜å¤œæ™¯", time: "æ™šä¸Š", desc: "è¬åœ‹å»ºç¯‰ç¾¤æ¼«æ­¥", nav: "å¤–ç˜" },
                { type: "food", title: "å°æ¥Šç”Ÿç… & èŸ¹é»ƒéºµ", time: "æ™šé¤", desc: "å¿…é»ï¼šèŸ¹ç²‰ç”Ÿç…", nav: "å°æ¥Šç”Ÿç…" }
            ]
        },
        {
            date: "12/25 (å››)", location: "å“ˆçˆ¾æ¿± -> ç€‹é™½", weather: "â„ï¸ -15Â°C",
            events: [
                { type: "transport", title: "âœˆï¸ ä¸Šæµ· - å“ˆçˆ¾æ¿±", time: "07:00", desc: "é£›å¾€å†°åŸ", nav: "" },
                { type: "transport", title: "ğŸš„ å“ˆçˆ¾æ¿± - ç€‹é™½", time: "11:57", desc: "G1238 é«˜éµ", nav: "å“ˆçˆ¾æ¿±è¥¿ç«™" },
                { type: "view", title: "æ²é‡Œæ²å¤– æ´—æµ´", time: "å‚æ™š", desc: "æ±åŒ—æ“æ¾¡é«”é©—", nav: "æ²é‡Œæ²å¤–" },
                { type: "stay", title: "ğŸš‚ K7565 è‡¥é‹ªç«è»Š", time: "21:09", desc: "å‰å¾€é˜¿çˆ¾å±±", nav: "ç€‹é™½ç«™" }
            ]
        },
        {
            date: "12/26 (äº”)", location: "é˜¿çˆ¾å±±", weather: "â„ï¸ -30Â°C",
            events: [
                { type: "view", title: "é˜¿çˆ¾å±±æ™¯å€", time: "å…¨å¤©", desc: "é§å³°å¶ºå¤©æ± ã€æœéµ‘æ¹–", nav: "é˜¿çˆ¾å±±åœ‹å®¶æ£®æ—å…¬åœ’", tips: "æ¥µå†·ï¼æ‰‹æ©Ÿè¦è²¼æš–å¯¶å¯¶" },
                { type: "stay", title: "é˜¿çˆ¾å±±æ™¯å€ä½å®¿", time: "æ™šä¸Š", desc: "æ™¯å€å…§éå¤œ", nav: "" }
            ]
        },
        {
            date: "12/27 (å…­)", location: "æ»¿æ´²é‡Œ", weather: "â„ï¸ -25Â°C",
            events: [
                { type: "view", title: "ä¸å‡æ²³ & å‘¼å€«æ¹–", time: "ç™½å¤©", desc: "çœ‹éœ§å‡‡ã€è—å†°", nav: "ä¸å‡æ²³" },
                { type: "view", title: "æ»¿æ´²é‡Œåœ‹é–€", time: "å‚æ™š", desc: "ä¸­ä¿„é‚Šå¢ƒã€å¥—å¨ƒå»£å ´", nav: "å¥—å¨ƒå»£å ´" },
                { type: "food", title: "ç›§å¸ƒé‡Œè¥¿é¤å»³", time: "æ™šé¤", desc: "ä¿„å¼ç´…èœæ¹¯ã€ç½ç‰›", nav: "ç›§å¸ƒé‡Œè¥¿é¤å»³" },
                { type: "transport", title: "ğŸš‚ K7090 è‡¥é‹ªç«è»Š", time: "20:50", desc: "è¿”å›å“ˆçˆ¾æ¿±", nav: "æ»¿æ´²é‡Œç«™" }
            ]
        },
        {
            date: "12/28 (æ—¥)", location: "å“ˆçˆ¾æ¿±", weather: "â„ï¸ -20Â°C",
            events: [
                { type: "view", title: "ç´¢éäºæ•™å ‚", time: "ä¸Šåˆ", desc: "æ‹é›ªæ™¯å¤§ç‰‡", nav: "è–ç´¢è²äºå¤§æ•™å ‚" },
                { type: "view", title: "å†°é›ªå¤§ä¸–ç•Œ", time: "15:00", desc: "å¿…ç©ï¼šæ¥µé€Ÿå¤§æ»‘æ¢¯", nav: "å†°é›ªå¤§ä¸–ç•Œ" },
                { type: "food", title: "éµé‹ç‡‰ / ç‡’çƒ¤", time: "æ™šé¤", desc: "æ±åŒ—ç‰¹è‰²", nav: "è€é“å¤–" }
            ]
        },
        {
            date: "12/29 (ä¸€)", location: "å“ˆçˆ¾æ¿± -> æ­å·", weather: "â˜ï¸",
            events: [
                { type: "view", title: "ç´…ç£šè¡—æ—©å¸‚", time: "æ—©æ™¨", desc: "åƒæ²¹ç‚¸ç³•ã€å–å¤§ç¢´ç²¥", nav: "ç´…å°ˆè¡—æ—©å¸‚" },
                { type: "transport", title: "âœˆï¸ å“ˆçˆ¾æ¿± - æ­å·", time: "19:20", desc: "é£›å¾€æ­å·", nav: "å“ˆçˆ¾æ¿±æ©Ÿå ´" }
            ]
        }
    ];

    // æ¸²æŸ“è¡Œç¨‹ (æœ¬åœ°éœæ…‹)
    const content = document.getElementById('itinerary-content');
    itineraryData.forEach(day => {
        let eventsHtml = '';
        day.events.forEach(ev => {
            const navLink = ev.nav ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ev.nav)}" target="_blank" class="btn-nav">ğŸ“ å°èˆª</a>` : '';
            const tips = ev.tips ? `<div class="guide-tip">ğŸ’¡ ${ev.tips}</div>` : '';
            eventsHtml += `
                <div class="card type-${ev.type}">
                    <h3 class="card-title">${ev.title}</h3>
                    <span class="card-time">${ev.time}</span>
                    <div class="card-desc">${ev.desc}</div>
                    ${tips} ${navLink}
                </div>`;
        });
        content.innerHTML += `
            <div class="day-header">${day.date} <span style="font-size:14px;color:#666">${day.location}</span></div>
            <div class="weather-banner"><div>${day.weather}</div></div>
            ${eventsHtml}
        `;
    });

    // Tab åˆ‡æ›
    window.switchTab = function(id, el) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
    }
</script>

</body>
</html>
